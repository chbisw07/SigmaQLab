// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © AlgoAlpha

//@version=5
strategy("Zero Lag Trend Strategy (MTF) [AlgoAlpha]", shorttitle="AlgoAlpha - 0️⃣Zero Lag Strategy", overlay=true, initial_capital=100000, default_qty_type=strategy.cash, default_qty_value=20000, pyramiding=1)

// ─────────────────────────────────────────────────────────────────────────────
// 1. USER INPUTS
// ─────────────────────────────────────────────────────────────────────────────
length = input.int(70, "Length", tooltip="The Look-Back window for the Zero-Lag EMA calculations", group="Main Calculations")
mult = input.float(1.2, "Band Multiplier", tooltip="Controls the thickness of the bands, a larger value makes it less noisy", group="Main Calculations")

t1 = input.timeframe("5", "Time frame 1", group="Extra Timeframes")
t2 = input.timeframe("15", "Time frame 2", group="Extra Timeframes")
t3 = input.timeframe("60", "Time frame 3", group="Extra Timeframes")
t4 = input.timeframe("240", "Time frame 4", group="Extra Timeframes")
t5 = input.timeframe("1D", "Time frame 5", group="Extra Timeframes")

bullColor = input.color(#00ffbb, "Bullish Color", group="Appearance")
bearColor = input.color(#ff1100, "Bearish Color", group="Appearance")

stopLossPerc = input.float(2.0, "Stop Loss %", minval=0, group="Risk Management")
takeProfitPerc = input.float(4.0, "Take Profit %", minval=0, group="Risk Management")

// Option to trade long‐only or both sides:
takeLongOnly = input.bool(false, "Take Long-Only Trades?", tooltip="If true, no new short entries are opened.")

// ─────────────────────────────────────────────────────────────────────────────
// 2. ZERO-LAG & TREND CALCULATION
// ─────────────────────────────────────────────────────────────────────────────
src = close
lag = math.floor((length - 1) / 2)
zlema = ta.ema(src + (src - src[lag]), length)
volatility = ta.highest(ta.atr(length), length * 3) * mult

var trend = 0
if ta.crossover(close, zlema + volatility)
    trend := 1
if ta.crossunder(close, zlema - volatility)
    trend := -1

// ─────────────────────────────────────────────────────────────────────────────
// 3. PLOTTING: ZERO-LAG EMA & BAND
// ─────────────────────────────────────────────────────────────────────────────
zlemaColor = trend == 1 ? color.new(bullColor, 70) : color.new(bearColor, 70)
m = plot(zlema, title="Zero Lag Basis", linewidth=2, color=zlemaColor)
upper = plot(trend == -1 ? zlema + volatility : na, style=plot.style_linebr, color=color.new(bearColor, 90), title="Upper Deviation Band")
lower = plot(trend == 1 ? zlema - volatility : na, style=plot.style_linebr, color=color.new(bullColor, 90), title="Lower Deviation Band")
fill(m, upper, (open + close) / 2, zlema + volatility, color.new(bearColor, 90), color.new(bearColor, 70))
fill(m, lower, (open + close) / 2, zlema - volatility, color.new(bullColor, 90), color.new(bullColor, 70))

// ─────────────────────────────────────────────────────────────────────────────
// 4. LARGE ARROWS (TREND REVERSALS)
// ─────────────────────────────────────────────────────────────────────────────
plotshape(ta.crossunder(trend, 0) ? zlema + volatility : na, title="Bearish Trend", style=shape.labeldown, location=location.absolute, color=bearColor, text="▼", textcolor=chart.fg_color, size=size.small)
plotshape(ta.crossover(trend, 0) ? zlema - volatility : na, title="Bullish Trend", style=shape.labelup, location=location.absolute, color=bullColor, text="▲", textcolor=chart.fg_color, size=size.small)

// ─────────────────────────────────────────────────────────────────────────────
// 5. OPTIONAL SMALL ARROWS (NOT USED FOR TRADING EXITS/ENTRIES)
// ─────────────────────────────────────────────────────────────────────────────
plotchar(ta.crossover(close, zlema) and trend == 1 and trend[1] == 1 ? zlema - volatility * 1.5 : na, title="Bullish Entry", char="▲", location=location.absolute, color=bullColor, size=size.tiny)
plotchar(ta.crossunder(close, zlema) and trend == -1 and trend[1] == -1 ? zlema + volatility * 1.5 : na, title="Bearish Entry", char="▼", location=location.absolute, color=bearColor, size=size.tiny)

// ─────────────────────────────────────────────────────────────────────────────
// 6. STRATEGY LOGIC: TRADE EXACTLY ON TREND REVERSAL
// ─────────────────────────────────────────────────────────────────────────────
bullReversal = ta.crossover(trend, 0) // from -1 to +1
bearReversal = ta.crossunder(trend, 0) // from +1 to -1

// if bullReversal
//     // Close all positions, then open a new long
//     strategy.close_all(comment="Close All on Bullish Reversal")
//     strategy.entry("Long", strategy.long, comment="New Bullish Trend Reversal")

// if bearReversal and not takeLongOnly
//     // Close all positions, then open a new short
//     strategy.close_all(comment="Close All on Bearish Reversal")
//     strategy.entry("Short", strategy.short, comment="New Bearish Trend Reversal")

// CB: new logic
pyramidLimit = 2  // ✅ Define pyramiding limit manually (must match the strategy setting)

if bullReversal
    strategy.close("Short")  // ✅ Close short positions before opening long
    if strategy.position_size < pyramidLimit  // ✅ Use custom pyramid limit
        strategy.entry("Long", strategy.long, comment="New Bullish Trend Reversal")

if bearReversal and not takeLongOnly
    strategy.close("Long")  // ✅ Close long positions before opening short
    if strategy.position_size > -pyramidLimit  // ✅ Use custom pyramid limit
        strategy.entry("Short", strategy.short, comment="New Bearish Trend Reversal")


// ─────────────────────────────────────────────────────────────────────────────
// 7. EXITS: STOP-LOSS / TAKE-PROFIT
// ─────────────────────────────────────────────────────────────────────────────
longStopPrice = strategy.position_avg_price * (1.0 - stopLossPerc / 100.0)
longProfPrice = strategy.position_avg_price * (1.0 + takeProfitPerc / 100.0)
strategy.exit("Long Exit", "Long", stop=longStopPrice, limit=longProfPrice)

shortStopPrice = strategy.position_avg_price * (1.0 + stopLossPerc / 100.0)
shortProfPrice = strategy.position_avg_price * (1.0 - takeProfitPerc / 100.0)
strategy.exit("Short Exit", "Short", stop=shortStopPrice, limit=shortProfPrice)

// ─────────────────────────────────────────────────────────────────────────────
// 8. MULTI-TIMEFRAME READS & TABLE
// ─────────────────────────────────────────────────────────────────────────────
s1 = request.security(syminfo.tickerid, t1, trend)
s2 = request.security(syminfo.tickerid, t2, trend)
s3 = request.security(syminfo.tickerid, t3, trend)
s4 = request.security(syminfo.tickerid, t4, trend)
s5 = request.security(syminfo.tickerid, t5, trend)

s1a = s1 == 1 ? "Bullish" : "Bearish"
s2a = s2 == 1 ? "Bullish" : "Bearish"
s3a = s3 == 1 ? "Bullish" : "Bearish"
s4a = s4 == 1 ? "Bullish" : "Bearish"
s5a = s5 == 1 ? "Bullish" : "Bearish"

if barstate.islast
    var data_table = table.new(position=position.top_right, columns=2, rows=6, bgcolor=chart.bg_color, border_width=1, border_color=chart.fg_color, frame_color=chart.fg_color, frame_width=1)
    table.cell(data_table, text_halign=text.align_center, column=0, row=0, text="Time Frame", text_color=chart.fg_color)
    table.cell(data_table, text_halign=text.align_center, column=1, row=0, text="Signal", text_color=chart.fg_color)
    table.cell(data_table, text_halign=text.align_center, column=0, row=1, text=t1, text_color=chart.fg_color)
    table.cell(data_table, text_halign=text.align_center, column=1, row=1, text=s1a, text_color=chart.fg_color, bgcolor=s1a == "Bullish" ? color.new(bullColor, 70) : color.new(bearColor, 70))
    table.cell(data_table, text_halign=text.align_center, column=0, row=2, text=t2, text_color=chart.fg_color)
    table.cell(data_table, text_halign=text.align_center, column=1, row=2, text=s2a, text_color=chart.fg_color, bgcolor=s2a == "Bullish" ? color.new(bullColor, 70) : color.new(bearColor, 70))
    table.cell(data_table, text_halign=text.align_center, column=0, row=3, text=t3, text_color=chart.fg_color)
    table.cell(data_table, text_halign=text.align_center, column=1, row=3, text=s3a, text_color=chart.fg_color, bgcolor=s3a == "Bullish" ? color.new(bullColor, 70) : color.new(bearColor, 70))
    table.cell(data_table, text_halign=text.align_center, column=0, row=4, text=t4, text_color=chart.fg_color)
    table.cell(data_table, text_halign=text.align_center, column=1, row=4, text=s4a, text_color=chart.fg_color, bgcolor=s4a == "Bullish" ? color.new(bullColor, 70) : color.new(bearColor, 70))
    table.cell(data_table, text_halign=text.align_center, column=0, row=5, text=t5, text_color=chart.fg_color)
    table.cell(data_table, text_halign=text.align_center, column=1, row=5, text=s5a, text_color=chart.fg_color, bgcolor=s5a == "Bullish" ? color.new(bullColor, 70) : color.new(bearColor, 70))

// ─────────────────────────────────────────────────────────────────────────────
// 9. ALERTCONDITIONS
// ─────────────────────────────────────────────────────────────────────────────
alertcondition(bullReversal, "Bullish Trend Reversal", "Trend turned from Bearish to Bullish. Consider going Long.")
alertcondition(bearReversal, "Bearish Trend Reversal", "Trend turned from Bullish to Bearish. Consider going Short.")
alertcondition(ta.cross(trend, 0), "(Bullish or Bearish) Trend Reversal")
